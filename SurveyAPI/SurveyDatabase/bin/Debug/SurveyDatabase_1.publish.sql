/*
Deployment script for SurveyDatabase

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "SurveyDatabase"
:setvar DefaultFilePrefix "SurveyDatabase"
:setvar DefaultDataPath "C:\Users\Swathi Arun\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\Swathi Arun\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The column [dbo].[tblQuestionType].[IsOptionsRequired] on table [dbo].[tblQuestionType] must be added, but the column has no default value and does not allow NULL values. If the table contains data, the ALTER script will not work. To avoid this issue you must either: add a default value to the column, mark it as allowing NULL values, or enable the generation of smart-defaults as a deployment option.
*/

IF EXISTS (select top 1 1 from [dbo].[tblQuestionType])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Altering [dbo].[tblQuestionType]...';


GO
ALTER TABLE [dbo].[tblQuestionType]
    ADD [IsOptionsRequired] BIT NOT NULL;


GO
PRINT N'Creating [dbo].[uspCreateQuestion]...';


GO
CREATE PROCEDURE [dbo].[uspCreateQuestion]
	@Question  nvarchar(MAX),
	@TypeId int,
	@SurveyId int,
	@QuestionNumber int
AS
DECLARE @Count INT = 0
DECLARE @QuestionId INT =0
SELECT @Count = COUNT(*) FROM tblQuestionType WHERE Id = @TypeId

IF @Count > 0
BEGIN
	INSERT INTO tblQuestions (Question,QuestionType) VALUES (@Question,@TypeId)
	SET @QuestionId = SCOPE_IDENTITY()

	INSERT INTO tblSurveyQuestionMapping (QuestionId,SurveyId,QuestionNumber) VALUES (@QuestionId,@SurveyId,@QuestionNumber)
	RETURN 1
END
RETURN 0
GO
PRINT N'Creating [dbo].[uspDeleteOptions]...';


GO
CREATE PROCEDURE [dbo].[uspDeleteOptions]
	@QuestionId int  
AS
	DELETE tblOptions WHERE QuestionId = @QuestionId
RETURN 1
GO
PRINT N'Creating [dbo].[uspDeleteQuestion]...';


GO
CREATE PROCEDURE [dbo].[uspDeleteQuestion]
	@QuestionId int  
AS
	DELETE tblOptions WHERE QuestionId = @QuestionId
	DELETE tblSurveyQuestionMapping WHERE QuestionId = @QuestionId
	DELETE tblQuestions WHERE Id = @QuestionId
RETURN 1
GO
PRINT N'Creating [dbo].[uspGetSurveyDetails]...';


GO
CREATE PROCEDURE [dbo].[uspGetSurveyDetails]
	@SurveyId int  
AS
	SELECT s.Id as SurveyId, s.Title as SurveyTitle,s.Description as SurveyDescription,
		s.StartDate as SurveyStartDate,s.EndDate as SurveyEndDate,s.IsOpen as IsOpen,
		q.Id as QuestionId,q.Question as Question,
		t.Id as QuestionTypeId,t.QuestionType as QuestionType,t.IsOptionsRequired as IsOptionsRequired,
		o.Id as OptionId,o.OptionText as OptionText
		
	FROM tblSurveyQuestionMapping m
	JOIN tblSurvey s ON s.Id = m.SurveyId
	JOIN tblQuestions q ON q.Id = m.QuestionId
	JOIN tblQuestionType t ON t.Id = q.QuestionType
	LEFT OUTER JOIN tblOptions o ON o.QuestionId = m.QuestionId

	WHERE CONVERT(date, s.StartDate) >= CONVERT(date, GETDATE())
	AND CONVERT(date,s.EndDate) <= CONVERT(date,GETDATE())
	AND s.IsOpen = 1
	AND s.Id = @SurveyId
RETURN 0
GO
PRINT N'Creating [dbo].[uspSaveAnswer]...';


GO
CREATE PROCEDURE [dbo].[uspSaveAnswer]
	@SurveyId int,
	@QuestionId int,
	@OptionId int =0,
	@Answer nvarchar(MAX) = NULL,
	@PersonName nvarchar(200),
	@PersonEmail nvarchar(300)
AS
DECLARE @Count INT = 0
DECLARE @PersonId INT = 0
DECLARE @IsOptionRequired BIT =0
--Get person Id
SELECT @PersonId = Id FROM tblPerson WHERE EmailId = @PersonEmail
IF @PersonId IS NULL OR @PersonId = 0
BEGIN
	INSERT INTO tblPerson (EmailId,Name) VALUES (@PersonEmail,@PersonName)
	SET @PersonId = SCOPE_IDENTITY()
END

--Check If Question, survey exists
SELECT @Count = COUNT(*) FROM tblSurveyQuestionMapping WHERE QuestionId = @QuestionId AND SurveyId = @SurveyId
IF @Count > 0
BEGIN
	SELECT @IsOptionRequired = IsOptionsRequired FROM tblQuestionType  WHERE Id = 
	(SELECT QuestionType FROM tblQuestions WHERE Id = @QuestionId)
	IF @IsOptionRequired = 1
	BEGIN
	--Check if option exists
		SELECT @Count = COUNT(*) FROM tblOptions WHERE Id = @OptionId AND QuestionId = @QuestionId
		IF @Count > 0
		BEGIN
			--Save Option
			INSERT INTO tblAnswers (AnswerText,OptionId,PersonId,QuestionId,SurveyId) VALUES (NULL,@OptionId,@PersonId,@QuestionId,@SurveyId)
			RETURN 1 --Success
		END
		ELSE
		RETURN 2 --No Option Available
	END
	ELSE
	BEGIN
		--Save Answer
		INSERT INTO tblAnswers (AnswerText,OptionId,PersonId,QuestionId,SurveyId) VALUES (@Answer,0,@PersonId,@QuestionId,@SurveyId)
		RETURN 1 --Success
	END
END
RETURN 0 -- qstn or survey does not exist
GO
PRINT N'Creating [dbo].[uspSaveOption]...';


GO
CREATE PROCEDURE [dbo].[uspSaveOption]
	@OptionText nvarchar(500),
	@QuestionId int
AS
 DECLARE @IsRequired BIT = 0
 --Check if Options required
  SELECT @IsRequired =  IsOptionsRequired FROM tblQuestionType  WHERE Id = 
	(SELECT QuestionType FROM tblQuestions WHERE Id = @QuestionId)

IF @IsRequired = 1
BEGIN
	INSERT INTO tblOptions (OptionText,QuestionId) VALUES (@OptionText,@QuestionId)
	RETURN 1
END
RETURN 0
GO
PRINT N'Creating [dbo].[uspSaveQuestionType]...';


GO
CREATE PROCEDURE [dbo].[uspSaveQuestionType]
	@QuestionType nvarchar(200) ,
	@IsOptionsRequired bit
AS
DECLARE @Count INT = 0
SELECT @Count = COUNT(*) FROM tblQuestionType WHERE QuestionType = @QuestionType
IF @Count = 0
BEGIN
	INSERT INTO tblQuestionType (QuestionType,IsOptionsRequired) VALUES (@QuestionType,@IsOptionsRequired)
	RETURN 1
END
RETURN 0
GO
PRINT N'Creating [dbo].[uspUpdateQuestion]...';


GO
CREATE PROCEDURE [dbo].[uspUpdateQuestion]
	@QuestionId int,
	@Question  nvarchar(MAX),
	@TypeId int,
	@SurveyId int,
	@QuestionNumber int
AS
DECLARE @Count INT = 0
 
SELECT @Count = COUNT(*) FROM tblQuestionType WHERE Id = @TypeId

IF @Count > 0
BEGIN
	UPDATE tblQuestions SET Question=@Question,QuestionType=@TypeId 
	WHERE Id=@QuestionId	 

	UPDATE tblSurveyQuestionMapping SET  SurveyId =@SurveyId ,QuestionNumber=@QuestionNumber 
	WHERE QuestionId = @QuestionId
	RETURN 1
END
RETURN 0
GO
PRINT N'Update complete.';


GO
